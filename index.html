<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>Kleuter Cijfer Pop</title>
<style>
  :root{
    --bg1: #f3f1ff;
    --bg2: #eaf7ff;
    --ink: #0b1020;
    --bubble-hl: #ffffff;
    --bubble-mid: #eff9ff;
    --bubble-lo: #d6f0ff;
    --bubble-glow: rgba(255,255,255,.85);
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color: rgba(0,0,0,0) }
  html, body{
    margin:0; height:100%;
    background:#fff; color:var(--ink);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    overscroll-behavior: none; touch-action: none;
  }
  #app{
    position:fixed; inset:0; width:100vw; height:100vh; overflow:hidden;
    background: radial-gradient(120% 120% at 70% 20%, var(--bg1) 0%, var(--bg2) 60%, #ffffff 100%);
    transition: background .6s ease;
  }
  /* parallax vlekken */
  .parallax{ position:absolute; inset:-10%; pointer-events:none; filter: blur(20px); opacity:.35 }
  .blob{ position:absolute; width: 35vmax; height:35vmax; border-radius:50%;
    background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.65), rgba(255,255,255,0));
    animation: float 38s linear infinite; mix-blend-mode: screen }
  .blob.b2{ width:28vmax; height:28vmax; animation-duration:46s; opacity:.28 }
  .blob.b3{ width:40vmax; height:40vmax; animation-duration:52s; opacity:.26 }
  @keyframes float{ 0%{transform:translate3d(-10%,-10%,0)} 50%{transform:translate3d(10%,8%,0)} 100%{transform:translate3d(-10%,-10%,0)} }

  /* UI */
  .ui{ position:absolute; left:0; right:0; top: env(safe-area-inset-top, 0px); display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px }
  .badge{ padding:10px 14px; border-radius:9999px; background: rgba(0,0,0,.06); border:1px solid rgba(0,0,0,.05); font-weight:900; font-size: clamp(14px, 2.2vmin, 18px) }
  .controls{ display:flex; gap:10px }
  .iconbtn{ display:flex; align-items:center; gap:10px; border:0; border-radius:9999px; padding:12px 16px; font-weight:900; font-size: clamp(14px, 2.2vmin, 18px); color:var(--ink); background: rgba(0,0,0,.08); border:1px solid rgba(0,0,0,.06); cursor:pointer }
  .iconbtn svg{ width:22px; height:22px }
  .roundbtn{ width:48px; height:48px; border-radius:9999px; display:grid; place-items:center; border:0; background: radial-gradient(circle at 30% 30%, #ffffff, #e9f3ff 70%); box-shadow: 0 6px 16px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,.9); cursor:pointer }
  .roundbtn svg{ width:22px; height:22px }

  /* start overlay */
  #startOverlay{ position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px; padding:24px; background: linear-gradient(180deg, rgba(255,255,255,.4), rgba(255,255,255,.7)); backdrop-filter: blur(4px); text-align:center }
  #startOverlay.hidden{ display:none }
  #startOverlay .title{ font-size: clamp(22px, 3.8vmin, 30px); font-weight:1000 }
  #startOverlay .hint{ font-size: clamp(14px, 2.2vmin, 18px); opacity:.9 }

  /* bubbels */
  .bubble{
    position:absolute; display:grid; place-items:center; border-radius:9999px;
    font-weight:1000; font-size: clamp(38px, 6.6vmin, 64px); color:#0b1020;
    background: radial-gradient(140% 140% at 30% 25%, var(--bubble-hl) 0%, var(--bubble-mid) 40%, var(--bubble-lo) 100%);
    border:2px solid rgba(255,255,255,.9);
    box-shadow: inset 0 1px 1px rgba(255,255,255,.8), inset 0 -10px 18px rgba(0,0,0,.08), 0 12px 28px rgba(0,0,0,.12);
    transform: translate3d(0,0,0) scale(1);
    will-change: transform; user-select:none; -webkit-user-select:none; transition: transform .16s ease;
  }
  .bubble::before{ content:""; position:absolute; inset:-18%; border-radius:inherit; background: radial-gradient(circle at 50% 50%, var(--bubble-glow), rgba(255,255,255,0) 60%); filter: blur(10px); z-index:-1 }
  .bubble::after{ content:""; position:absolute; top:12%; left:18%; width:28%; height:22%; border-radius:9999px; background: rgba(255,255,255,.65); filter: blur(1px); transform: rotate(12deg); pointer-events:none }

  /* pop en effecten */
  .pop{ animation: pop .33s cubic-bezier(.2,.9,.2,1) forwards }
  @keyframes pop{ 0%{transform: var(--t) scale(1) rotate(0); opacity:1} 45%{transform: var(--t) scale(1.25) rotate(5deg)} 100%{transform: var(--t) scale(.4) rotate(-10deg); opacity:0} }
  .ring{ position:absolute; pointer-events:none; border-radius:9999px; border:3px solid rgba(0,0,0,.12); transform: translate(-50%,-50%) scale(.6); opacity:.9; animation: ring .45s ease-out forwards }
  @keyframes ring{ to{ transform: translate(-50%,-50%) scale(1.45); opacity:0 } }
  .dot{ position:absolute; width:12px; height:12px; border-radius:9999px; opacity:.95; transform: translate(-50%,-50%) scale(1); animation: dot .55s ease-out forwards }
  @keyframes dot{ to{ transform: translate(var(--dx), var(--dy)) scale(.8); opacity:0 } }

  /* helperhand */
  .helper{ position:absolute; width:64px; height:64px; transform: translate(-50%,-50%); pointer-events:none; opacity:0; transition: opacity .25s ease }
  .helper.show{ opacity:.9 }
  .helper .hand{ width:100%; height:100%; animation: nod 1.2s ease-in-out infinite }
  @keyframes nod{ 0%,100%{ transform: translateY(0) rotate(0) } 50%{ transform: translateY(6px) rotate(2deg) } }

  /* toast */
  #toast{ position:absolute; left:50%; transform: translateX(-50%); bottom: calc(16px + env(safe-area-inset-bottom, 0px)); padding:10px 14px; background: rgba(0,0,0,.08); border:1px solid rgba(0,0,0,.06); color:var(--ink); border-radius:12px; font-weight:900; font-size:14px; opacity:0; transition: opacity .25s ease; pointer-events:none }
  #toast.show{ opacity:1 }

  /* leerkracht */
  .teacher-toggle{ position:absolute; left:12px; bottom: calc(12px + env(safe-area-inset-bottom, 0px)); display:flex; gap:8px }
  .chip{ border:1px solid rgba(0,0,0,.10); background: rgba(0,0,0,.06); padding:8px 10px; border-radius:9999px; font-weight:800; cursor:pointer }
  .panel{ position:absolute; left:12px; bottom: calc(60px + env(safe-area-inset-bottom, 0px)); width: min(92vw, 420px); background: rgba(255,255,255,.95); border:1px solid rgba(0,0,0,.08); border-radius:16px; box-shadow: 0 10px 28px rgba(0,0,0,.12); padding:12px; display:none }
  .panel.show{ display:block }
  .panel h3{ margin:6px 6px 10px; font-size:16px }
  .row{ display:flex; align-items:center; gap:10px; margin:10px 6px }
  .row label{ width:160px; font-weight:800; font-size:14px }
  .row input[type="range"]{ flex:1 }
  .row input[type="number"]{ width:90px; padding:6px 8px; border-radius:10px; border:1px solid rgba(0,0,0,.15) }
  .panel .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px }
  .panel button{ padding:8px 12px; border-radius:10px; border:1px solid rgba(0,0,0,.1); background: rgba(0,0,0,.06); font-weight:900; cursor:pointer }

  /* binnenkomst animatie voor terugkerende bellen */
  .slide-in{ transition: transform .9s cubic-bezier(.2,.9,.2,1) }
</style>
</head>
<body>
  <div id="app" role="application" aria-label="Kleuter Cijfer Pop">
    <div class="parallax" aria-hidden="true">
      <div class="blob" style="left:-8%; top:-6%"></div>
      <div class="blob b2" style="right:-6%; top:10%"></div>
      <div class="blob b3" style="left:20%; bottom:-12%"></div>
    </div>

    <div class="ui">
      <div class="badge" id="badge">Tik het getal op volgorde</div>
      <div class="controls">
        <button class="iconbtn" id="speakBtn" type="button" aria-label="Lees voor">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18c0 2 1.5 3 3 3s3-1 3-3c0-3 3-3 3-7a6 6 0 0 0-12 0"/><path d="M9 9a3 3 0 0 1 6 0"/></svg>
          Lees voor
        </button>
        <button class="roundbtn" id="resetBtn" type="button" aria-label="Opnieuw">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9"/><path d="M3 4v8h8"/></svg>
        </button>
      </div>
    </div>

    <div id="helper" class="helper" aria-hidden="true">
      <svg class="hand" viewBox="0 0 128 128">
        <g fill="#ffd7b8" stroke="#ccab93" stroke-width="2">
          <path d="M38 54c-6 2-9 8-8 14 2 10 10 21 18 28 9 8 20 12 31 11 7 0 12-6 12-13l-1-22c0-3-3-5-6-5h-6l1-8c0-3-2-6-5-6s-5 3-5 6v8h-4l1-10c0-3-2-6-5-6s-5 3-5 6v10h-4l1-10c0-3-2-6-5-6s-5 3-5 6v11z"/>
        </g>
        <circle cx="94" cy="94" r="10" fill="rgba(0,0,0,.10)"/>
      </svg>
    </div>

    <div id="startOverlay" aria-modal="true" role="dialog">
      <div class="title">Klaar voor het spel</div>
      <div class="hint">Klik de cijfers, op volgorde</div>
      <button class="iconbtn" id="startBtn" type="button">â–¶ Start</button>
    </div>

    <div id="toast" role="status" aria-live="polite"></div>

    <div class="teacher-toggle">
      <button class="chip" id="teacherBtn" type="button">Leerkracht</button>
      <button class="chip" id="exportBtn" type="button">Exporteer JSON</button>
      <button class="chip" id="exportCsvBtn" type="button">Exporteer CSV</button>
      <button class="chip" id="previewBtn" type="button">Bekijk log</button>
    </div>
    <div class="panel" id="teacherPanel" role="dialog" aria-label="Leerkracht instellingen">
      <h3>Instellingen</h3>
      <div class="row"><label for="maxWave">Maximaal cijfer</label><input id="maxWave" type="number" min="3" max="20" step="1" /></div>
      <div class="row"><label for="delay">Tijd tussen levels, seconden</label><input id="delay" type="number" min="0" max="5" step="0.5" /></div>
      <div class="row"><label>Snelheid bubbels</label><input id="minSpeed" type="range" min="4" max="40" step="1" /><input id="maxSpeed" type="range" min="6" max="50" step="1" /></div>
      <div class="row"><label for="logging">Logging aan, uit</label><input id="logging" type="checkbox" /></div>
      <div class="actions"><button id="saveTeacher" type="button">Bewaar</button><button id="closeTeacher" type="button">Sluit</button></div>
    </div>
  </div>

<script>
;(() => {
  const app = document.getElementById('app')
  const startOverlay = document.getElementById('startOverlay')
  const startBtn = document.getElementById('startBtn')
  const speakBtn = document.getElementById('speakBtn')
  const resetBtn = document.getElementById('resetBtn')
  const toast = document.getElementById('toast')
  const badge = document.getElementById('badge')
  const helper = document.getElementById('helper')

  const teacherBtn = document.getElementById('teacherBtn')
  const exportBtn = document.getElementById('exportBtn')
  const exportCsvBtn = document.getElementById('exportCsvBtn')
  const previewBtn = document.getElementById('previewBtn')
  const teacherPanel = document.getElementById('teacherPanel')
  const saveTeacher = document.getElementById('saveTeacher')
  const closeTeacher = document.getElementById('closeTeacher')
  const inputMaxWave = document.getElementById('maxWave')
  const inputDelay = document.getElementById('delay')
  const inputMinSpeed = document.getElementById('minSpeed')
  const inputMaxSpeed = document.getElementById('maxSpeed')
  const inputLogging = document.getElementById('logging')

  const PASTELS = [
    ['#fde2e4', '#fff1f1'], ['#dfe7fd', '#eef3ff'], ['#e4f1e1', '#f2faef'],
    ['#fff4cc', '#fff9e6'], ['#f3e8ff', '#f9f2ff'], ['#eaf7ff', '#f5fbff'],
    ['#ffe9f2', '#fff3f8'], ['#e9fff5', '#f3fffa'], ['#fff0e6', '#fff7f2'], ['#eef7ff', '#f6fbff']
  ]
  const NUM_WORDS_NL = {0:'nul',1:'Ã©Ã©n',2:'twee',3:'drie',4:'vier',5:'vijf',6:'zes',7:'zeven',8:'acht',9:'negen',10:'tien',11:'elf',12:'twaalf',13:'dertien',14:'veertien',15:'vijftien',16:'zestien',17:'zeventien',18:'achttien',19:'negentien',20:'twintig'}

  const SETTINGS_KEY = 'kleuter_cijferpop_settings'
  const LOG_KEY = 'kleuter_cijferpop_log'

  const state = {
    moving: false,
    wave: 1,
    requiredNext: 1,
    maxWave: 10,
    bubbles: [],
    velocities: [],
    jerkMeta: new Map(),
    runningRAF: 0,
    lastTime: 0,
    voice: null,
    minSpeed: 10,
    maxSpeed: 22,
    minSize: 110,
    maxSize: 190,
    interLevelDelay: 0.5,
    logging: true,           // standaard aan
    idleMs: 5000,
    lastInteraction: 0
  }

  function loadSettings(){
    try{
      const raw = localStorage.getItem(SETTINGS_KEY)
      if(raw){
        const s = JSON.parse(raw)
        if(typeof s.maxWave === 'number') state.maxWave = s.maxWave
        if(typeof s.interLevelDelay === 'number') state.interLevelDelay = s.interLevelDelay
        if(typeof s.minSpeed === 'number') state.minSpeed = s.minSpeed
        if(typeof s.maxSpeed === 'number') state.maxSpeed = s.maxSpeed
        if(typeof s.logging === 'boolean') state.logging = s.logging
      }
    }catch(e){}
    inputMaxWave.value = state.maxWave
    inputDelay.value = state.interLevelDelay
    inputMinSpeed.value = state.minSpeed
    inputMaxSpeed.value = state.maxSpeed
    inputLogging.checked = state.logging
  }
  function saveSettings(){
    state.maxWave = clampInt(parseInt(inputMaxWave.value,10), 3, 20)
    state.interLevelDelay = clampNum(parseFloat(inputDelay.value), 0, 5)
    state.minSpeed = clampNum(parseFloat(inputMinSpeed.value), 2, 40)
    state.maxSpeed = clampNum(parseFloat(inputMaxSpeed.value), state.minSpeed+1, 50)
    state.logging = !!inputLogging.checked
    localStorage.setItem(SETTINGS_KEY, JSON.stringify({
      maxWave: state.maxWave, interLevelDelay: state.interLevelDelay,
      minSpeed: state.minSpeed, maxSpeed: state.maxSpeed, logging: state.logging
    }))
    showToast('Instellingen bewaard')
  }

  function clampNum(v,a,b){ return Math.max(a, Math.min(b, v)) }
  function clampInt(v,a,b){ return Math.max(a, Math.min(b, v|0)) }
  function rand(min,max){ return Math.random() * (max - min) + min }

  function setPastelForWave(wave){
    const pair = PASTELS[(wave - 1) % PASTELS.length]
    document.documentElement.style.setProperty('--bg1', pair[0])
    document.documentElement.style.setProperty('--bg2', pair[1])
  }

  function resize(){ app.style.width = innerWidth + 'px'; app.style.height = innerHeight + 'px' }
  addEventListener('resize', resize, {passive:true})
  addEventListener('orientationchange', () => setTimeout(resize, 250))

  function showToast(msg){
    toast.textContent = msg
    toast.classList.add('show')
    clearTimeout(showToast._t)
    showToast._t = setTimeout(() => toast.classList.remove('show'), 1100)
  }

  // spraak
  function loadVoices(){ return new Promise(r => { const v = speechSynthesis.getVoices(); if(v.length) r(v); else speechSynthesis.onvoiceschanged = () => r(speechSynthesis.getVoices()) }) }
  function isFemaleName(name=''){ return /(claire|saskia|ellen|lotte|femke|mila|maja|vrouw|female|woman)/i.test(name) }
  function pickDutchFemale(vs){
    const nl = vs.filter(v => v.lang && v.lang.toLowerCase().startsWith('nl'))
    const fem = nl.filter(v => isFemaleName(v.name))
    return fem[0] || nl[0] || vs.find(v => isFemaleName(v.name)) || vs[0] || null
  }
  function word(n){ return NUM_WORDS_NL[n] || String(n) }
  function speak(text, rate=1.10){
    try{
      speechSynthesis.cancel()
      const u = new SpeechSynthesisUtterance(text)
      u.lang = 'nl-NL'; u.rate = rate
      if(state.voice) u.voice = state.voice
      speechSynthesis.speak(u)
    }catch(e){}
  }

  // logging
  function logEvent(type, data){
    if(!state.logging) return
    const entry = { t: Date.now(), wave: state.wave, need: state.requiredNext, type, ...data }
    try{
      const arr = JSON.parse(localStorage.getItem(LOG_KEY) || '[]')
      arr.push(entry)
      localStorage.setItem(LOG_KEY, JSON.stringify(arr))
    }catch(e){}
  }
  function exportJSON(){
    const arr = JSON.parse(localStorage.getItem(LOG_KEY) || '[]')
    const pretty = JSON.stringify(arr, null, 2)
    const blob = new Blob([pretty], {type:'application/json'})
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a'); a.href = url; a.download = 'cijferpop-log.json'
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
  }
  function exportCSV(){
    const arr = JSON.parse(localStorage.getItem(LOG_KEY) || '[]')
    const header = ['timestamp','wave','need','type','n','correct'].join(',')
    const lines = arr.map(x => [
      new Date(x.t).toISOString(),
      x.wave ?? '', x.need ?? '', x.type ?? '', x.n ?? '', x.correct ?? ''
    ].join(','))
    const blob = new Blob([[header].concat(lines).join('\n')], {type:'text/csv'})
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a'); a.href = url; a.download = 'cijferpop-log.csv'
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
  }
  function previewLog(){
    const arr = JSON.parse(localStorage.getItem(LOG_KEY) || '[]')
    const pretty = arr.length ? JSON.stringify(arr, null, 2) : '[]'
    const html = `<pre style="white-space:pre-wrap;padding:16px;font:14px/1.4 ui-monospace,SFMono-Regular,Menlo,monospace;">${pretty.replace(/[<>&]/g, s => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</pre>`
    const w = window.open('', '_blank'); if(w){ w.document.write(`<title>Log weergave</title>${html}`); w.document.close() } else { alert('Kan geen venster openen, mogelijk blokkeert je browser dit') }
  }

  // helperhand
  function hideHelper(){ helper.classList.remove('show') }
  function maybeShowHelper(){
    const now = performance.now()
    if(now - state.lastInteraction < state.idleMs) return
    let minB = null, minN = Infinity
    for(const b of state.bubbles){
      const n = parseInt(b.dataset.num,10)
      if(n < minN){ minN = n; minB = b }
    }
    if(!minB) return
    const r = minB.getBoundingClientRect()
    helper.style.left = r.left + r.width*0.2 + 'px'
    helper.style.top  = r.top  + r.height*0.2 + 'px'
    helper.classList.add('show')
  }
  function registerInteraction(){ state.lastInteraction = performance.now(); hideHelper() }
  document.addEventListener('pointerdown', registerInteraction, {passive:true})

  // bubbels
  function clearBubbles(){
    for(const b of state.bubbles){ b.removeEventListener('pointerdown', onBubbleTap); b.remove() }
    state.bubbles = []; state.velocities = []; state.jerkMeta.clear()
  }
  function createWaveBubbles(){
    clearBubbles()
    const W = app.clientWidth, H = app.clientHeight, pad = 16
    for(let n=1; n<=state.wave; n++){
      const el = document.createElement('div')
      el.className = 'bubble'; el.textContent = n; el.dataset.num = n
      const baseMin = Math.max(110, Math.min(innerWidth, innerHeight) * 0.16)
      const baseMax = Math.max(190, Math.min(innerWidth, innerHeight) * 0.26)
      const size = Math.floor(rand(baseMin, baseMax))
      el.style.width = size + 'px'; el.style.height = size + 'px'
      el.style.zIndex = String(1000 - n)

      let x = rand(pad, Math.max(pad, W - size)), y = rand(pad + 70, Math.max(pad + 70, H - size)), tries = 0
      while(overlapsExisting(x,y,size) && tries < 240){
        x = rand(pad, Math.max(pad, W - size)); y = rand(pad + 70, Math.max(pad + 70, H - size)); tries++
      }
      setTransform(el, x, y)
      el.dataset.x = x; el.dataset.y = y; el.dataset.size = size
      el.addEventListener('pointerdown', onBubbleTap, {passive:true})

      const sp = rand(state.minSpeed, state.maxSpeed), ang = rand(0, Math.PI*2)
      const v = { vx: Math.cos(ang)*sp, vy: Math.sin(ang)*sp }

      app.appendChild(el)
      state.bubbles.push(el); state.velocities.push(v)
      state.jerkMeta.set(el, { nextJerk: performance.now() + rand(300, 800) })
    }
    enforceStacking()
  }
  function setTransform(el, x, y){
    el.style.setProperty('--t', `translate3d(${x}px, ${y}px, 0)`)
    el.style.transform = `translate3d(${x}px, ${y}px, 0)`
  }
  function overlapsExisting(x,y,size){
    for(const b of state.bubbles){
      const bx = parseFloat(b.dataset.x), by = parseFloat(b.dataset.y), bs = parseFloat(b.dataset.size)
      const dx = (bx + bs*.5) - (x + size*.5), dy = (by + bs*.5) - (y + size*.5)
      const rr = (bs*.5 + size*.5); if(dx*dx + dy*dy < rr*rr * 0.92) return true
    }
    return false
  }
  function enforceStacking(){
    let minN = Infinity
    for(const b of state.bubbles){ const n = parseInt(b.dataset.num,10); if(n < minN) minN = n }
    for(const b of state.bubbles){ const n = parseInt(b.dataset.num,10); b.style.zIndex = String(1000 - n) }
    const minB = state.bubbles.find(b => parseInt(b.dataset.num,10) === minN)
    if(minB){ const x = parseFloat(minB.dataset.x), y = parseFloat(minB.dataset.y); minB.style.transform = `translate3d(${x}px, ${y}px, 1px)`; setTimeout(() => setTransform(minB, x, y), 0) }
  }

  // effecten
  function burst(x,y,baseSize){
    const ring = document.createElement('div'); ring.className = 'ring'
    const r = Math.max(30, baseSize * 0.55)
    ring.style.width = r + 'px'; ring.style.height = r + 'px'; ring.style.left = x + 'px'; ring.style.top = y + 'px'
    app.appendChild(ring); ring.addEventListener('animationend', () => ring.remove(), {once:true})
    const colors = ['#ffd6e7','#e2f2ff','#e6ffe8','#fff3d6','#f3e8ff']
    for(let i=0;i<3;i++){
      const d = document.createElement('div'); d.className = 'dot'
      d.style.left = x + 'px'; d.style.top = y + 'px'; d.style.background = colors[Math.floor(Math.random()*colors.length)]
      const dist = Math.max(28, baseSize * 0.35), ang = rand(0, Math.PI*2)
      d.style.setProperty('--dx', Math.cos(ang) * dist + 'px'); d.style.setProperty('--dy', Math.sin(ang) * dist + 'px')
      app.appendChild(d); d.addEventListener('animationend', () => d.remove(), {once:true})
    }
  }

  // kliklogica met volgorde en fout-afhandeling zonder teleport
  function onBubbleTap(e){
    const el = e.currentTarget
    const n = parseInt(el.dataset.num, 10)
    if(!state.bubbles.includes(el)) return

    const correct = n === state.requiredNext
    logEvent('tap', { n, correct })

    if(!correct){
      speak('Oeps, begin opnieuw bij Ã©Ã©n', 1.04)
      showToast('Fout, begin opnieuw bij 1')
      restartCurrentWaveWithoutTeleport()
      return
    }

    speak(word(n), 1.10)
    const rect = el.getBoundingClientRect()
    burst(rect.left + rect.width/2, rect.top + rect.height/2, parseFloat(el.dataset.size))
    el.classList.add('pop')
    el.addEventListener('animationend', () => {
      const idx = state.bubbles.indexOf(el)
      if(idx >= 0){ state.bubbles.splice(idx, 1); state.velocities.splice(idx, 1); state.jerkMeta.delete(el) }
      el.remove()
      state.requiredNext += 1
      if(state.bubbles.length === 0){
        setTimeout(nextWave, state.interLevelDelay * 1000)
      }else{
        enforceStacking()
      }
    }, {once:true})
  }

  // fout, bestaande bellen blijven staan, ontbrekende keren terug vanaf de zijkanten, zacht inschuiven
  function restartCurrentWaveWithoutTeleport(){
    logEvent('restart-wave', {})
    const have = new Set(state.bubbles.map(b => parseInt(b.dataset.num,10)))
    state.requiredNext = 1

    // bepaal welke nummers ontbreken in 1..wave
    const missing = []
    for(let n=1; n<=state.wave; n++){ if(!have.has(n)) missing.push(n) }

    // voeg ontbrekende toe, vanuit linker of rechterkant
    const W = app.clientWidth, H = app.clientHeight, pad = 16
    for(const n of missing){
      const el = document.createElement('div')
      el.className = 'bubble slide-in'
      el.textContent = n
      el.dataset.num = n
      const baseMin = Math.max(110, Math.min(innerWidth, innerHeight) * 0.16)
      const baseMax = Math.max(190, Math.min(innerWidth, innerHeight) * 0.26)
      const size = Math.floor(rand(baseMin, baseMax))
      el.style.width = size + 'px'; el.style.height = size + 'px'
      el.style.zIndex = String(1000 - n)

      // doelpositie
      let targetX = rand(pad, Math.max(pad, W - size))
      let targetY = rand(pad + 70, Math.max(pad + 70, H - size))
      let tries = 0
      while(overlapsExisting(targetX, targetY, size) && tries < 240){
        targetX = rand(pad, Math.max(pad, W - size))
        targetY = rand(pad + 70, Math.max(pad + 70, H - size))
        tries++
      }

      // startpositie net buiten scherm, links of rechts
      const side = Math.random() < 0.5 ? 'left' : 'right'
      const startX = side === 'left' ? -size - 20 : W + 20
      const startY = targetY

      // zet buiten beeld
      setTransform(el, startX, startY)
      el.dataset.x = targetX; el.dataset.y = targetY; el.dataset.size = size

      // klik handler
      el.addEventListener('pointerdown', onBubbleTap, {passive:true})

      // snelheid richting binnen
      const sp = rand(state.minSpeed, state.maxSpeed)
      const ang = Math.atan2(targetY - startY, targetX - startX)
      const v = { vx: Math.cos(ang)*sp, vy: Math.sin(ang)*sp }

      app.appendChild(el)
      state.bubbles.push(el); state.velocities.push(v); state.jerkMeta.set(el, { nextJerk: performance.now() + rand(300, 800) })

      // laat inschuiven naar doelpositie, daarna geef normale transform door aan physics
      requestAnimationFrame(() => {
        el.style.transition = 'transform .9s cubic-bezier(.2,.9,.2,1)'
        setTransform(el, targetX, targetY)
        setTimeout(() => {
          el.style.transition = '' // terug naar animatieloop
          // physics gaat door met huidige v, dataset.x,y blijven target zodat physics naadloos oppakt
        }, 900)
      })
    }

    // badge en stacking
    badge.textContent = `Tik de cijfers op volgorde, begin met 1`
    enforceStacking()
    state.lastInteraction = performance.now()
  }

  // volgende level
  function nextWave(){
    setPastelForWave(state.wave + 1)
    state.wave += 1
    if(state.wave > state.maxWave){
      state.wave = 1
      showToast('We beginnen opnieuw bij 1')
      speak('We beginnen opnieuw bij Ã©Ã©n', 1.02)
      logEvent('reset-cycle', {})
    }else{
      showToast(`Nu tot en met ${state.wave}`)
      speak(`Nu tot en met ${word(state.wave)}`, 1.02)
      logEvent('next-wave', { wave: state.wave })
    }
    state.moving = state.wave >= 2
    state.requiredNext = 1
    createWaveBubbles()
    badge.textContent = `Tik de cijfers op volgorde tot en met ${state.wave}`
    state.lastInteraction = performance.now()
  }

  // animatie, doelcijfer schokkeriger
  function tick(ts){
    maybeShowHelper()
    if(!state.moving){ state.lastTime = ts; state.runningRAF = requestAnimationFrame(tick); return }
    if(!state.lastTime) state.lastTime = ts
    const dt = Math.min(0.05, (ts - state.lastTime) / 1000); state.lastTime = ts
    const W = app.clientWidth, H = app.clientHeight

    for(let i=0;i<state.bubbles.length;i++){
      const el = state.bubbles[i], v = state.velocities[i]
      let x = parseFloat(el.dataset.x), y = parseFloat(el.dataset.y)
      const s = parseFloat(el.dataset.size)
      const n = parseInt(el.dataset.num,10), isTarget = n === state.requiredNext

      if(isTarget){
        const meta = state.jerkMeta.get(el), now = performance.now()
        if(meta && now >= meta.nextJerk){
          const sp = rand(state.minSpeed*0.8, state.maxSpeed*1.1), angle = rand(0, Math.PI*2)
          v.vx = Math.cos(angle)*sp; v.vy = Math.sin(angle)*sp
          meta.nextJerk = now + rand(220, 600)
        }
        v.vx += rand(-5, 5) * dt; v.vy += rand(-5, 5) * dt
      }

      x += v.vx * dt; y += v.vy * dt
      if(x <= 0){ x = 0; v.vx = Math.abs(v.vx)*0.98 }
      if(y <= 0){ y = 0; v.vy = Math.abs(v.vy)*0.98 }
      if(x + s >= W){ x = W - s; v.vx = -Math.abs(v.vx)*0.98 }
      if(y + s >= H){ y = H - s; v.vy = -Math.abs(v.vy)*0.98 }

      el.dataset.x = x; el.dataset.y = y
      setTransform(el, x, y)
    }
    if(Math.floor(performance.now()/1000)%2===0){ enforceStacking() }
    state.runningRAF = requestAnimationFrame(tick)
  }

  // start en reset
  async function enterFullscreen(){ const el = document.documentElement; try{ if(el.requestFullscreen) await el.requestFullscreen(); else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen() }catch(e){} }
  async function start(){
    await enterFullscreen(); resize(); loadSettings()
    const voices = await loadVoices(); state.voice = pickDutchFemale(voices)
    state.wave = 1; state.requiredNext = 1; state.moving = false
    setPastelForWave(1); clearBubbles(); createWaveBubbles()
    badge.textContent = 'Tik het getal op volgorde'
    startOverlay.classList.add('hidden'); showToast('Tik 1'); speak('Tik Ã©Ã©n', 1.10)
    state.lastInteraction = performance.now()
    cancelAnimationFrame(state.runningRAF); state.lastTime = 0; state.runningRAF = requestAnimationFrame(tick)
    logEvent('start', {})
  }
  function reset(){ logEvent('reset', {}); start() }

  // UI events
  startBtn.addEventListener('click', start)
  resetBtn.addEventListener('click', reset)
  speakBtn.addEventListener('click', () => {
    if(state.bubbles.length === 1 && state.wave === 1){ speak('Tik Ã©Ã©n', 1.10); showToast('Tik 1') }
    else{ speak(`Tik de cijfers op volgorde tot en met ${word(state.wave)}`, 1.08) }
  })
  teacherBtn.addEventListener('click', () => { teacherPanel.classList.toggle('show'); if(teacherPanel.classList.contains('show')) loadSettings() })
  closeTeacher.addEventListener('click', () => teacherPanel.classList.remove('show'))
  saveTeacher.addEventListener('click', () => { saveSettings(); teacherPanel.classList.remove('show') })
  exportBtn.addEventListener('click', exportJSON)
  exportCsvBtn.addEventListener('click', exportCSV)
  previewBtn.addEventListener('click', previewLog)
  ;['pointerdown','keydown','touchstart'].forEach(ev => document.addEventListener(ev, () => { state.lastInteraction = performance.now(); hideHelper() }, {passive:true}))

  resize()
  document.addEventListener('touchmove', e => e.preventDefault(), {passive:false})
})();
</script>
</body>
</html>
