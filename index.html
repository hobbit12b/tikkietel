<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>Cijfer Pop Spel</title>
  <style>
    :root{
      --hue: 220;
      --bg-a: hsl(var(--hue) 40% 14%);
      --bg-b: hsl(calc(var(--hue) + 20) 45% 9%);
      --fg: #ffffff;
      --bubble1: #a8ecff;
      --bubble2: #7bdbff;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: rgba(0,0,0,0) }
    html, body{
      margin:0;
      height:100%;
      background: #000;
      color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      overscroll-behavior: none;
      touch-action: none;
    }
    #app{
      position:fixed;
      inset:0;
      width:100vw;
      height:100vh;
      overflow:hidden;
      background: radial-gradient(120% 120% at 80% 20%, var(--bg-a) 0%, var(--bg-b) 55%, #060a14 100%);
      transition: background .6s ease;
    }
    .ui{
      position:absolute;
      left:0;
      right:0;
      top: env(safe-area-inset-top, 0px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px 16px;
      pointer-events:none;
    }
    .badge{
      pointer-events:auto;
      padding: 8px 12px;
      border-radius: 9999px;
      background: rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
      font-weight: 700;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .controls{ display:flex; gap:8px; pointer-events:auto }
    button{
      border:0;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 800;
      font-size: 14px;
      color: #0b1020;
      background: linear-gradient(135deg, #7fd8ff, #c2a6ff);
      box-shadow: 0 6px 20px rgba(110,231,255,.2);
      cursor:pointer;
    }
    button.secondary{
      color: var(--fg);
      background: rgba(255,255,255,.1);
      box-shadow: none;
      border: 1px solid rgba(255,255,255,.12);
    }

    /* Start-overlay voor gebruikersactie, nodig voor audio op iOS */
    #startOverlay{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:18px;
      padding: 24px;
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.6));
      backdrop-filter: blur(6px);
      text-align:center;
    }
    #startOverlay.hidden{ display:none }
    #startOverlay .title{ font-size: clamp(22px, 3.8vmin, 30px); font-weight: 900 }
    #startOverlay .hint{ font-size: clamp(14px, 2.2vmin, 18px); opacity:.9 }

    /* Bubbels */
    .bubble{
      position:absolute;
      display:grid;
      place-items:center;
      width: clamp(64px, 10vmin, 96px);
      height: clamp(64px, 10vmin, 96px);
      border-radius: 9999px;
      font-weight: 1000;
      font-size: clamp(22px, 4.2vmin, 34px);
      color: #0b1020;
      background: radial-gradient(140% 140% at 30% 25%, #ffffff 0%, #d9f7ff 35%, var(--bubble1) 70%, var(--bubble2) 100%);
      border: 2px solid rgba(255,255,255,.7);
      box-shadow:
        inset 0 1px 1px rgba(255,255,255,.6),
        inset 0 -8px 14px rgba(0,0,0,.12),
        0 12px 30px rgba(0,0,0,.25);
      transform: translate3d(0,0,0) scale(1);
      will-change: transform;
      user-select:none; -webkit-user-select:none;
      transition: transform .2s ease;
    }
    .bubble::after{
      content:"";
      position:absolute;
      top: 12%;
      left: 18%;
      width: 28%;
      height: 22%;
      border-radius: 9999px;
      background: rgba(255,255,255,.65);
      filter: blur(1px);
      transform: rotate(12deg);
      pointer-events:none;
    }
    .pop{
      animation: pop .26s ease forwards;
    }
    @keyframes pop{
      0%{ transform: var(--t) scale(1); opacity:1 }
      60%{ transform: var(--t) scale(1.18); opacity:1 }
      100%{ transform: var(--t) scale(.6); opacity:0 }
    }

    /* Toast onderin voor korte hints */
    #toast{
      position:absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      padding: 10px 14px;
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--fg);
      border-radius: 12px;
      font-weight: 700;
      font-size: 14px;
      opacity: 0;
      transition: opacity .25s ease;
      pointer-events:none;
    }
    #toast.show{ opacity: 1 }
  </style>
</head>
<body>
  <div id="app" aria-label="Cijfer Pop Spel" role="application">
    <div class="ui">
      <div class="badge" id="badge">Tik het getal dat je ziet</div>
      <div class="controls">
        <button id="speakBtn" class="secondary" type="button" aria-label="Lees de opdracht">Lees voor</button>
        <button id="resetBtn" class="secondary" type="button" aria-label="Opnieuw">Opnieuw</button>
      </div>
    </div>

    <div id="startOverlay" aria-modal="true" role="dialog">
      <div class="title">Klaar voor het spel</div>
      <div class="hint">Tik op Start, geef toestemming voor geluid, je ziet eerst alleen 1</div>
      <button id="startBtn" type="button">Start</button>
    </div>

    <div id="toast" role="status" aria-live="polite"></div>
  </div>

  <script>
  ;(() => {
    const app = document.getElementById('app')
    const startOverlay = document.getElementById('startOverlay')
    const startBtn = document.getElementById('startBtn')
    const speakBtn = document.getElementById('speakBtn')
    const resetBtn = document.getElementById('resetBtn')
    const toast = document.getElementById('toast')
    const badge = document.getElementById('badge')

    const NUM_WORDS_NL = {
      0:'nul',1:'één',2:'twee',3:'drie',4:'vier',5:'vijf',6:'zes',7:'zeven',8:'acht',9:'negen',10:'tien',
      11:'elf',12:'twaalf',13:'dertien',14:'veertien',15:'vijftien',16:'zestien',17:'zeventien',18:'achttien',19:'negentien',20:'twintig'
    }

    const state = {
      moving: false,         // beweging aan of uit
      wave: 1,               // huidige ronde, toont 1..wave
      maxWave: 10,           // tot 10, daarna reset
      bubbles: [],
      velocities: [],
      runningRAF: 0,
      lastTime: 0,
      voice: null,
      minSpeed: 12,          // px/s
      maxSpeed: 26,          // px/s
      hue: 220
    }

    // Fullscreen
    async function enterFullscreen(){
      const el = document.documentElement
      try{
        if(el.requestFullscreen) await el.requestFullscreen()
        else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen()
      }catch(e){}
    }

    function resize(){
      app.style.width = innerWidth + 'px'
      app.style.height = innerHeight + 'px'
    }
    addEventListener('resize', resize, {passive:true})
    addEventListener('orientationchange', () => setTimeout(resize, 250))

    function rand(min, max){ return Math.random() * (max - min) + min }

    function showToast(msg){
      toast.textContent = msg
      toast.classList.add('show')
      clearTimeout(showToast._t)
      showToast._t = setTimeout(() => toast.classList.remove('show'), 1100)
    }

    // Spraak
    function loadVoices(){
      return new Promise(resolve => {
        let v = speechSynthesis.getVoices()
        if(v.length) resolve(v)
        else speechSynthesis.onvoiceschanged = () => resolve(speechSynthesis.getVoices())
      })
    }
    function pickDutchVoice(vs){
      const first = vs.find(v => v.lang?.toLowerCase().startsWith('nl')) ||
                    vs.find(v => /dutch|nederlands/i.test(v.name)) ||
                    vs[0]
      return first || null
    }
    function numberWord(n){
      if(NUM_WORDS_NL[n]) return NUM_WORDS_NL[n]
      return String(n)  // fallback
    }
    function speak(text, rate=1.02){
      try{
        speechSynthesis.cancel()
        const u = new SpeechSynthesisUtterance(text)
        u.lang = 'nl-NL'
        u.rate = rate
        if(state.voice) u.voice = state.voice
        speechSynthesis.speak(u)
      }catch(e){}
    }

    // Bubbels maken voor ronde 1..wave
    function createWaveBubbles(){
      clearBubbles()
      const W = app.clientWidth
      const H = app.clientHeight
      const pad = 16

      for(let n=1; n<=state.wave; n++){
        const el = document.createElement('div')
        el.className = 'bubble'
        el.textContent = n
        el.dataset.num = n
        el.style.zIndex = String(1000 - n) // laagste cijfer bovenop

        // tijdelijke meting
        app.appendChild(el)
        const s = Math.max(el.getBoundingClientRect().width, el.getBoundingClientRect().height)
        el.remove()

        // posities, boven UI balk
        let x = rand(pad, Math.max(pad, W - s))
        let y = rand(pad + 60, Math.max(pad + 60, H - s))
        // eenvoudige overlapvermijding
        let tries = 0
        while(overlapsExisting(x, y, s) && tries < 200){
          x = rand(pad, Math.max(pad, W - s))
          y = rand(pad + 60, Math.max(pad + 60, H - s))
          tries++
        }

        el.style.setProperty('--t', `translate3d(${x}px, ${y}px, 0)`)
        el.style.transform = `translate3d(${x}px, ${y}px, 0)`
        el.dataset.x = x
        el.dataset.y = y
        el.dataset.size = s

        el.addEventListener('pointerdown', onBubbleTap, {passive:true})

        // snelheid alleen als beweging aanstaat
        const sp = rand(state.minSpeed, state.maxSpeed)
        const angle = rand(0, Math.PI * 2)
        const v = { vx: Math.cos(angle)*sp, vy: Math.sin(angle)*sp }

        app.appendChild(el)
        state.bubbles.push(el)
        state.velocities.push(v)
      }

      enforceStacking()
    }

    function overlapsExisting(x, y, size){
      for(const b of state.bubbles){
        const bx = parseFloat(b.dataset.x)
        const by = parseFloat(b.dataset.y)
        const bs = parseFloat(b.dataset.size)
        const dx = (bx + bs*.5) - (x + size*.5)
        const dy = (by + bs*.5) - (y + size*.5)
        const rr = (bs*.5 + size*.5)
        if(dx*dx + dy*dy < rr*rr * 0.92) return true
      }
      return false
    }

    function clearBubbles(){
      for(const b of state.bubbles){
        b.removeEventListener('pointerdown', onBubbleTap)
        b.remove()
      }
      state.bubbles = []
      state.velocities = []
    }

    // Tik op bubbel
    function onBubbleTap(e){
      const el = e.currentTarget
      const n = parseInt(el.dataset.num, 10)
      // alleen klikken als hij nog zichtbaar is
      if(!state.bubbles.includes(el)) return

      // spreek cijfernaam
      speak(numberWord(n))
      // pop animatie
      el.classList.add('pop')
      el.addEventListener('animationend', () => {
        const idx = state.bubbles.indexOf(el)
        if(idx >= 0){
          state.bubbles.splice(idx, 1)
          state.velocities.splice(idx, 1)
        }
        el.remove()
        // ronde klaar
        if(state.bubbles.length === 0){
          nextWave()
        }else{
          // blijf de laagste bovenop houden
          enforceStacking()
        }
      }, {once:true})
    }

    // Laagste cijfer bovenop
    function enforceStacking(){
      let minN = Infinity
      for(const b of state.bubbles){
        const n = parseInt(b.dataset.num, 10)
        if(n < minN) minN = n
      }
      for(const b of state.bubbles){
        const n = parseInt(b.dataset.num, 10)
        b.style.zIndex = String(1000 - n)
      }
      const minB = state.bubbles.find(b => parseInt(b.dataset.num,10) === minN)
      if(minB){
        // micro bump in transform stack voor bovenlaag
        const x = parseFloat(minB.dataset.x), y = parseFloat(minB.dataset.y)
        minB.style.transform = `translate3d(${x}px, ${y}px, 1px)`
        setTimeout(() => { minB.style.transform = `translate3d(${x}px, ${y}px, 0)` }, 0)
      }
    }

    // Volgende ronde
    function nextWave(){
      // achtergrondkleur verschuiven
      state.hue = (state.hue + 33) % 360
      document.documentElement.style.setProperty('--hue', state.hue)

      // verhoog wave, reset als > max
      state.wave = state.wave + 1
      if(state.wave > state.maxWave){
        state.wave = 1
        showToast('We beginnen opnieuw bij 1')
        speak('We beginnen opnieuw bij één', 1.0)
      }else{
        showToast(`Nu tot en met ${state.wave}`)
        speak(`Nu tot en met ${numberWord(state.wave)}`, 1.0)
      }

      // vanaf wave 2 bewegen de cijfers langzaam
      state.moving = state.wave >= 2

      // maak nieuwe set
      createWaveBubbles()
      badge.textContent = `Tik de cijfers weg tot en met ${state.wave}`
    }

    // Animatie loop
    function tick(ts){
      if(!state.moving){ state.lastTime = ts; state.runningRAF = requestAnimationFrame(tick); return }
      if(!state.lastTime) state.lastTime = ts
      const dt = Math.min(0.05, (ts - state.lastTime) / 1000)
      state.lastTime = ts

      const W = app.clientWidth
      const H = app.clientHeight

      for(let i=0;i<state.bubbles.length;i++){
        const el = state.bubbles[i]
        const v = state.velocities[i]
        let x = parseFloat(el.dataset.x)
        let y = parseFloat(el.dataset.y)
        const s = parseFloat(el.dataset.size)

        x += v.vx * dt
        y += v.vy * dt

        // randen, zacht kaatsen
        if(x <= 0){ x = 0; v.vx = Math.abs(v.vx) }
        if(y <= 0){ y = 0; v.vy = Math.abs(v.vy) }
        if(x + s >= W){ x = W - s; v.vx = -Math.abs(v.vx) }
        if(y + s >= H){ y = H - s; v.vy = -Math.abs(v.vy) }

        el.dataset.x = x
        el.dataset.y = y
        el.style.setProperty('--t', `translate3d(${x}px, ${y}px, 0)`)
        el.style.transform = `translate3d(${x}px, ${y}px, 0)`
      }

      // elke seconde stapeling herbevestigen
      if(Math.floor(performance.now()/1000)%2===0){
        enforceStacking()
      }

      state.runningRAF = requestAnimationFrame(tick)
    }

    // Start, Reset
    async function start(){
      await enterFullscreen()
      resize()
      const voices = await loadVoices()
      state.voice = pickDutchVoice(voices)

      // begincondities
      state.wave = 1
      state.moving = false            // eerste keer, alleen 1 zichtbaar en niet bewegen
      clearBubbles()
      createWaveBubbles()
      badge.textContent = 'Tik het getal dat je ziet'
      startOverlay.classList.add('hidden')
      showToast('Tik 1')
      speak('Tik één', 1.02)

      cancelAnimationFrame(state.runningRAF)
      state.lastTime = 0
      state.runningRAF = requestAnimationFrame(tick)
    }

    function reset(){
      // nieuwe kleur en volledig opnieuw
      state.hue = 220
      document.documentElement.style.setProperty('--hue', state.hue)
      start()
    }

    // UI events
    startBtn.addEventListener('click', start)
    resetBtn.addEventListener('click', reset)
    speakBtn.addEventListener('click', () => {
      if(state.bubbles.length === 1 && state.wave === 1){
        speak('Tik één', 1.02)
        showToast('Tik 1')
      }else{
        speak(`Tik de cijfers weg tot en met ${numberWord(state.wave)}`, 1.02)
      }
    })

    // Eerste layout en iOS scrollpreventie
    resize()
    document.addEventListener('touchmove', e => e.preventDefault(), {passive:false})

  })()
  </script>
</body>
</html>
